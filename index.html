<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Damage Assessment - IICRC S500 Compliant</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(135deg, #2c5282 0%, #3182ce 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .header p { font-size: 0.9rem; opacity: 0.9; }

        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 4px;
            margin-top: 15px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #48bb78;
            width: 0%;
            transition: width 0.3s ease;
        }

        .content { padding: 25px 20px; }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .step.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .consultant-message {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            border-left: 4px solid #3182ce;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .consultant-message h3 {
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .consultant-message h3::before {
            content: "🎯";
            margin-right: 8px;
        }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .room-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .room-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .room-card:hover {
            border-color: #3182ce;
            background: #ebf8ff;
        }

        .room-card.selected {
            border-color: #3182ce;
            background: #3182ce;
            color: white;
        }

        .photo-upload {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .photo-upload:hover {
            border-color: #3182ce;
            background: #f7fafc;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-preview img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
        }

        .moisture-readings {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .reading-input {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }

        .reading-input input, .reading-input select {
            padding: 8px 12px;
            font-size: 14px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(49, 130, 206, 0.3);
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .environmental-data {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .env-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .env-item {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }

        .equipment-recommendations {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .equipment-room {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .equipment-list {
            margin-top: 10px;
        }

        .equipment-item {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e53e3e;
        }

        .success {
            background: #c6f6d5;
            color: #276749;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #48bb78;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3182ce;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .insights {
            background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .iicrc-compliance {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-item {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .class-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .class-1 { background: #48bb78; color: white; }
        .class-2 { background: #ed8936; color: white; }
        .class-3 { background: #e53e3e; color: white; }
        .class-4 { background: #9f7aea; color: white; }

        /* Auto-save notification styles */
        @keyframes slideDown {
            from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .auto-save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #48bb78;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Water Damage Assessment</h1>
            <p>IICRC S500 Compliant | Mobile First</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>

        <div class="auto-save-indicator" id="autoSaveIndicator">
            ✓ Saved
        </div>

        <div class="content">
            <!-- Step 1: Job Information -->
            <div class="step active" id="step1">
                <div class="consultant-message">
                    <h3>Initial Assessment</h3>
                    <p>Let's start by gathering the basic job information. I'll guide you through a comprehensive IICRC-compliant assessment process.</p>
                </div>

                <div class="form-group">
                    <label>Job Address</label>
                    <input type="text" id="jobAddress" value="2630 New Haven Blvd, Navarre, FL, 32566">
                </div>

                <div class="form-group">
                    <label>Homeowner Name</label>
                    <input type="text" id="homeownerName" value="Vickie Vale">
                </div>

                <div class="form-group">
                    <label>Contact Phone</label>
                    <input type="tel" id="contactPhone" value="660-864-5202">
                </div>

                <div class="form-group">
                    <label>Technician Name</label>
                    <input type="text" id="technicianName" placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label>Water Source/Cause of Loss</label>
                    <select id="waterSource">
                        <option value="washing_machine" selected>Washing Machine Leak</option>
                        <option value="supply_line">Supply Line Break</option>
                        <option value="toilet_overflow">Toilet Overflow</option>
                        <option value="dishwasher">Dishwasher Leak</option>
                        <option value="water_heater">Water Heater Failure</option>
                        <option value="hvac">HVAC Condensation</option>
                        <option value="roof_leak">Roof Leak</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <button class="btn" onclick="nextStep()">Begin Assessment</button>
            </div>

            <!-- Step 2: Environmental Data -->
            <div class="step" id="step2">
                <div class="consultant-message">
                    <h3>Environmental Conditions</h3>
                    <p>I'm automatically pulling current weather data for your location. This is crucial for proper psychrometric calculations and drying strategy.</p>
                </div>

                <div class="environmental-data" id="environmentalData">
                    <h4>📊 Current Environmental Conditions</h4>
                    <div class="env-grid">
                        <div class="env-item">
                            <strong>Temperature</strong>
                            <div id="outsideTemp">Loading...</div>
                        </div>
                        <div class="env-item">
                            <strong>Humidity</strong>
                            <div id="outsideHumidity">Loading...</div>
                        </div>
                        <div class="env-item">
                            <strong>Pressure</strong>
                            <div id="outsidePressure">Loading...</div>
                        </div>
                        <div class="env-item">
                            <strong>GPP</strong>
                            <div id="outsideGPP">Loading...</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Indoor Temperature (°F)</label>
                    <input type="number" id="indoorTemp" placeholder="72">
                </div>

                <div class="form-group">
                    <label>Indoor Relative Humidity (%)</label>
                    <input type="number" id="indoorHumidity" placeholder="45">
                </div>

                <button class="btn" onclick="nextStep()">Continue to Room Assessment</button>
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            </div>

            <!-- Step 3: Room Selection -->
            <div class="step" id="step3">
                <div class="consultant-message">
                    <h3>Affected Areas Identification</h3>
                    <p>Based on your initial report, I've pre-selected the known affected areas. Please confirm and add any additional areas you discover.</p>
                </div>

                <div class="room-grid" id="roomGrid">
                    <div class="room-card selected" data-room="laundry">Laundry Room</div>
                    <div class="room-card selected" data-room="hallway">Hallway</div>
                    <div class="room-card selected" data-room="master_bedroom">Master Bedroom</div>
                    <div class="room-card selected" data-room="dining_room">Dining Room</div>
                    <div class="room-card" data-room="kitchen">Kitchen</div>
                    <div class="room-card" data-room="living_room">Living Room</div>
                    <div class="room-card" data-room="bathroom">Bathroom</div>
                    <div class="room-card" data-room="basement">Basement</div>
                    <div class="room-card" data-room="garage">Garage</div>
                    <div class="room-card" data-room="other">Other Room</div>
                </div>

                <div class="form-group">
                    <label>Additional Room (if "Other" selected)</label>
                    <input type="text" id="otherRoom" placeholder="Specify room name">
                </div>

                <button class="btn" onclick="nextStep()">Start Room-by-Room Assessment</button>
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            </div>

            <!-- Step 4: Room Assessment -->
            <div class="step" id="step4">
                <div class="consultant-message">
                    <h3 id="currentRoomTitle">Room Assessment</h3>
                    <p id="currentRoomGuidance">Let's assess this room thoroughly. Document flooring, moisture readings, and affected materials.</p>
                </div>

                <div class="form-group">
                    <label>Primary Flooring Type</label>
                    <select id="flooringType">
                        <option value="">Select flooring type</option>
                        <option value="hardwood">Hardwood</option>
                        <option value="laminate">Laminate</option>
                        <option value="carpet">Carpet</option>
                        <option value="tile">Ceramic/Porcelain Tile</option>
                        <option value="luxury_vinyl">Luxury Vinyl Plank/Tile</option>
                        <option value="vinyl">Sheet Vinyl</option>
                        <option value="concrete">Concrete</option>
                        <option value="engineered_wood">Engineered Wood</option>
                        <option value="bamboo">Bamboo</option>
                        <option value="other_flooring">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Room Dimensions (Length x Width in feet)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="roomLength" placeholder="Length">
                        <input type="number" id="roomWidth" placeholder="Width">
                    </div>
                </div>

                <div class="moisture-readings">
                    <h4>📏 Moisture Readings</h4>
                    <p style="font-size: 0.9rem; margin-bottom: 15px;">Take readings at multiple locations. Click "Add Reading" for each measurement point.</p>
                    
                    <div id="moistureReadings">
                        <div class="reading-input">
                            <select class="material-type">
                                <option value="">Material Type</option>
                                <option value="wood_floor">Wood Flooring</option>
                                <option value="subfloor">Subfloor</option>
                                <option value="carpet_pad">Carpet/Pad</option>
                                <option value="drywall_bottom">Drywall (Bottom)</option>
                                <option value="drywall_2ft">Drywall (2ft up)</option>
                                <option value="baseboard">Baseboard</option>
                                <option value="concrete">Concrete</option>
                                <option value="insulation">Insulation</option>
                            </select>
                            <input type="number" placeholder="% MC" class="moisture-reading">
                            <input type="text" placeholder="Location" class="reading-location">
                        </div>
                    </div>
                    <button type="button" onclick="addMoistureReading()" style="padding: 8px 16px; background: #4a5568; color: white; border: none; border-radius: 4px; margin-top: 10px;">Add Reading</button>
                </div>

                <div class="form-group">
                    <label>Affected Materials (check all that apply)</label>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" style="margin-right: 10px; width: auto;"> Flooring
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" style="margin-right: 10px; width: auto;"> Baseboards/Trim
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" style="margin-right: 10px; width: auto;"> Drywall (bottom 2 feet)
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" style="margin-right: 10px; width: auto;"> Insulation
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" style="margin-right: 10px; width: auto;"> Personal Contents
                        </label>
                        <label style="display: flex; align-items: center; font-weight: normal;">
                            <input type="checkbox" style="margin-right: 10px; width: auto;"> Subfloor
                        </label>
                    </div>
                </div>

                <div class="photo-upload" onclick="document.getElementById('roomPhotos').click()">
                    <p>📷 Add Photos for This Room</p>
                    <p style="font-size: 0.85rem; opacity: 0.7; margin-top: 5px;">Before, during, and damage documentation</p>
                    <input type="file" id="roomPhotos" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(this)">
                </div>
                <div class="photo-preview" id="photoPreview"></div>

                <div class="form-group">
                    <label>Additional Notes for This Room</label>
                    <textarea id="roomNotes" rows="3" placeholder="Document any specific observations, damage severity, or special conditions..."></textarea>
                </div>

                <button class="btn" onclick="saveRoomAndNext()">Save Room & Continue</button>
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            </div>

            <!-- Step 5: Equipment Recommendations -->
            <div class="step" id="step5">
                <div class="consultant-message">
                    <h3>IICRC Equipment Recommendations</h3>
                    <p>Based on your assessment data, I've calculated the optimal equipment placement per IICRC S500 standards. Review and confirm placement.</p>
                </div>

                <div class="equipment-recommendations">
                    <h4>🔧 Equipment Deployment Plan</h4>
                    <div id="equipmentPlan">
                        <!-- Equipment recommendations will be populated here -->
                    </div>
                </div>

                <div class="iicrc-compliance">
                    <h4>✅ IICRC S500 Compliance Checklist</h4>
                    <div class="checkbox-grid" id="complianceChecklist">
                        <div class="checkbox-item">
                            <input type="checkbox" id="safety_assessed">
                            <label for="safety_assessed">Safety hazards assessed and documented</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="water_source_stopped">
                            <label for="water_source_stopped">Water source stopped and secured</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="class_determined">
                            <label for="class_determined">Water damage class determined</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="category_determined">
                            <label for="category_determined">Water category determined</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="moisture_mapped">
                            <label for="moisture_mapped">Moisture mapping completed</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="psychrometric_calculated">
                            <label for="psychrometric_calculated">Psychrometric calculations performed</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="equipment_calculated">
                            <label for="equipment_calculated">Equipment needs calculated per affected area</label>
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="nextStep()">Finalize Assessment</button>
                <button class="btn btn-secondary" onclick="prevStep()">Back</button>
            </div>

            <!-- Step 6: Final Summary & Email -->
            <div class="step" id="step6">
                <div class="consultant-message">
                    <h3>Assessment Complete</h3>
                    <p>Excellent work! Your comprehensive assessment is complete. Review the summary and send the report to your team.</p>
                </div>

                <div class="insights">
                    <h4>🎯 Key Insights & Recommendations</h4>
                    <div id="keyInsights">
                        <!-- Insights will be populated here -->
                    </div>
                </div>

                <div class="summary-section">
                    <h4>📋 Assessment Summary</h4>
                    <div id="assessmentSummary">
                        <!-- Summary will be populated here -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Additional Comments for Team</label>
                    <textarea id="finalComments" rows="3" placeholder="Any additional observations, customer requests, or follow-up items..."></textarea>
                </div>

                <button class="btn" onclick="sendReport()">📧 Send Report to Team</button>
                <button class="btn btn-secondary" onclick="generatePDF()">📄 Generate PDF Report</button>

                <div class="loading" id="sendingReport">
                    <div class="spinner"></div>
                    <p>Sending comprehensive report...</p>
                </div>

                <div class="success" id="reportSent" style="display: none;">
                    <p><strong>✅ Report sent successfully!</strong></p>
                    <p>Jeannie and Zac have received your detailed assessment with all photos and recommendations.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State with Auto-Save
        let currentStep = 1;
        let totalSteps = 6;
        let selectedRooms = ['laundry', 'hallway', 'master_bedroom', 'dining_room'];
        let currentRoomIndex = 0;
        let roomData = {};
        let allPhotos = [];
        let environmentalData = {};

        // Auto-save functionality
        function saveProgress() {
            const progressData = {
                currentStep,
                selectedRooms,
                currentRoomIndex,
                roomData,
                environmentalData,
                timestamp: new Date().toISOString(),
                // Collect current form data
                formData: gatherCurrentFormData()
            };
            sessionStorage.setItem('waterAssessmentProgress', JSON.stringify(progressData));
            showAutoSaveIndicator();
        }

        function gatherCurrentFormData() {
            const formData = {};
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    formData[input.id] = input.checked;
                } else if (input.type !== 'file') {
                    formData[input.id] = input.value;
                }
            });
            return formData;
        }

        function loadProgress() {
            const saved = sessionStorage.getItem('waterAssessmentProgress');
            if (saved) {
                try {
                    const progressData = JSON.parse(saved);
                    const savedTime = new Date(progressData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff < 4) {
                        currentStep = progressData.currentStep;
                        selectedRooms = progressData.selectedRooms || ['laundry', 'hallway', 'master_bedroom', 'dining_room'];
                        currentRoomIndex = progressData.currentRoomIndex || 0;
                        roomData = progressData.roomData || {};
                        environmentalData = progressData.environmentalData || {};
                        
                        // Restore form values
                        if (progressData.formData) {
                            Object.keys(progressData.formData).forEach(key => {
                                const element = document.getElementById(key);
                                if (element) {
                                    if (element.type === 'checkbox') {
                                        element.checked = progressData.formData[key];
                                    } else {
                                        element.value = progressData.formData[key];
                                    }
                                }
                            });
                        }
                        
                        // Update room selection
                        updateRoomSelection();
                        
                        // Show the correct step
                        document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
                        document.getElementById(`step${currentStep}`).classList.add('active');
                        updateProgress();
                        
                        // Show recovery message
                        showRecoveryMessage();
                    }
                } catch (error) {
                    console.error('Error loading saved progress:', error);
                }
            }
        }

        function updateRoomSelection() {
            document.querySelectorAll('.room-card').forEach(card => {
                if (selectedRooms.includes(card.dataset.room)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function showRecoveryMessage() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #48bb78;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideDown 0.5s ease;
            `;
            notification.innerHTML = `
                <strong>✅ Progress Restored!</strong><br>
                Continuing from Step ${currentStep}
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        function setupAutoSave() {
            document.addEventListener('input', debounce(saveProgress, 1000));
            document.addEventListener('change', saveProgress);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function clearProgress() {
            sessionStorage.removeItem('waterAssessmentProgress');
        }

        // Weather API integration using OpenWeather API
        async function getEnvironmentalData() {
            console.log('Starting weather data fetch...');
            
            try {
                const apiKey = '8f55419e9cfa47b2e39ed197ec1fcf90';
                const lat = 30.4081;
                const lon = -87.0692;
                
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=imperial`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Weather data received:', data);
                
                if (data.main) {
                    const temp = Math.round(data.main.temp);
                    const humidity = data.main.humidity;
                    const pressure = (data.main.pressure * 0.02953).toFixed(2);
                    const gpp = calculateGPP(temp, humidity);
                    
                    document.getElementById('outsideTemp').textContent = temp + '°F';
                    document.getElementById('outsideHumidity').textContent = humidity + '%';
                    document.getElementById('outsidePressure').textContent = pressure + ' inHg';
                    document.getElementById('outsideGPP').textContent = gpp + ' gr/lb';
                    
                    environmentalData = { temp, humidity, pressure, gpp };
                    console.log('Environmental data set:', environmentalData);
                } else {
                    throw new Error('Invalid API response - no main data');
                }
            } catch (error) {
                console.error('Weather data error:', error);
                console.log('Using fallback weather data for Gulf Coast area');
                
                const temp = 87;
                const humidity = 65;
                const pressure = 30.09;
                const gpp = calculateGPP(temp, humidity);
                
                document.getElementById('outsideTemp').textContent = temp + '°F';
                document.getElementById('outsideHumidity').textContent = humidity + '%';
                document.getElementById('outsidePressure').textContent = pressure + ' inHg';
                document.getElementById('outsideGPP').textContent = gpp + ' gr/lb';
                
                environmentalData = { temp, humidity, pressure, gpp };
                
                const tempElement = document.getElementById('outsideTemp');
                tempElement.title = 'Using estimated data - API unavailable';
                tempElement.style.opacity = '0.8';
            }
        }

        // Calculate Grains Per Pound (GPP) - Fixed formula
        function calculateGPP(tempF, rh) {
            const tempC = (tempF - 32) * 5/9;
            const saturationPressure = 6.112 * Math.exp((17.67 * tempC) / (tempC + 243.5));
            const actualVaporPressure = (rh / 100) * saturationPressure;
            const actualVaporPressurePsia = actualVaporPressure * 0.145038;
            const atmosphericPressurePsia = 14.696;
            const humidityRatio = 0.622 * (actualVaporPressurePsia / (atmosphericPressurePsia - actualVaporPressurePsia));
            const gpp = Math.round(humidityRatio * 7000);
            return gpp;
        }

        // Navigation functions
        function nextStep() {
            if (currentStep < totalSteps) {
                saveProgress();
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                
                if (currentStep === 2) {
                    if (environmentalData.temp && environmentalData.humidity) {
                        document.getElementById('indoorTemp').value = environmentalData.temp;
                        document.getElementById('indoorHumidity').value = environmentalData.humidity;
                    }
                } else if (currentStep === 4 && currentRoomIndex === 0) {
                    setupRoomAssessment();
                } else if (currentStep === 5) {
                    generateEquipmentRecommendations();
                } else if (currentStep === 6) {
                    generateFinalSummary();
                }
                
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                saveProgress();
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateProgress();
            }
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        // Room selection logic
        function initializeRoomSelection() {
            const roomCards = document.querySelectorAll('.room-card');
            roomCards.forEach(card => {
                card.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateSelectedRooms();
                    saveProgress();
                });
            });
        }

        function updateSelectedRooms() {
            selectedRooms = [];
            document.querySelectorAll('.room-card.selected').forEach(card => {
                selectedRooms.push(card.dataset.room);
            });
        }

        // Photo handling
        function handlePhotoUpload(input) {
            const files = Array.from(input.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = {
                        file: file,
                        dataUrl: e.target.result,
                        room: selectedRooms[currentRoomIndex],
                        timestamp: new Date().toISOString()
                    };
                    allPhotos.push(photoData);
                    displayPhotoPreview(photoData);
                };
                reader.readAsDataURL(file);
            });
        }

        function displayPhotoPreview(photoData) {
            const preview = document.getElementById('photoPreview');
            const img = document.createElement('img');
            img.src = photoData.dataUrl;
            img.onclick = () => window.open(photoData.dataUrl, '_blank');
            preview.appendChild(img);
        }

        // Moisture reading functions
        function addMoistureReading() {
            const container = document.getElementById('moistureReadings');
            const newReading = document.createElement('div');
            newReading.className = 'reading-input';
            newReading.innerHTML = `
                <select class="material-type">
                    <option value="">Material Type</option>
                    <option value="wood_floor">Wood Flooring</option>
                    <option value="subfloor">Subfloor</option>
                    <option value="carpet_pad">Carpet/Pad</option>
                    <option value="drywall_bottom">Drywall (Bottom)</option>
                    <option value="drywall_2ft">Drywall (2ft up)</option>
                    <option value="baseboard">Baseboard</option>
                    <option value="concrete">Concrete</option>
                    <option value="insulation">Insulation</option>
                </select>
                <input type="number" placeholder="% MC" class="moisture-reading">
                <input type="text" placeholder="Location" class="reading-location">
            `;
            container.appendChild(newReading);
        }

        // Room assessment setup
        function setupRoomAssessment() {
            if (currentRoomIndex < selectedRooms.length) {
                const roomName = selectedRooms[currentRoomIndex].replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('currentRoomTitle').textContent = `${roomName} Assessment`;
                document.getElementById('currentRoomGuidance').textContent = `Room ${currentRoomIndex + 1} of ${selectedRooms.length}: Document all conditions and moisture readings for proper IICRC classification.`;
                
                document.getElementById('photoPreview').innerHTML = '';
                document.getElementById('roomPhotos').value = '';
            }
        }

        function saveRoomAndNext() {
            const currentRoom = selectedRooms[currentRoomIndex];
            const moistureReadings = [];
            
            document.querySelectorAll('#moistureReadings .reading-input').forEach(reading => {
                const material = reading.querySelector('.material-type').value;
                const moisture = reading.querySelector('.moisture-reading').value;
                const location = reading.querySelector('.reading-location').value;
                
                if (material && moisture && location) {
                    moistureReadings.push({ material, moisture: parseFloat(moisture), location });
                }
            });

            const affectedMaterials = [];
            document.querySelectorAll('#step4 input[type="checkbox"]:checked').forEach(checkbox => {
                affectedMaterials.push(checkbox.parentElement.textContent.trim());
            });

            roomData[currentRoom] = {
                name: currentRoom.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()),
                flooring: document.getElementById('flooringType').value,
                length: parseFloat(document.getElementById('roomLength').value) || 0,
                width: parseFloat(document.getElementById('roomWidth').value) || 0,
                area: (parseFloat(document.getElementById('roomLength').value) || 0) * (parseFloat(document.getElementById('roomWidth').value) || 0),
                moistureReadings,
                affectedMaterials,
                notes: document.getElementById('roomNotes').value,
                photos: allPhotos.filter(photo => photo.room === currentRoom)
            };

            currentRoomIndex++;
            
            if (currentRoomIndex < selectedRooms.length) {
                // Clear form for next room
                document.getElementById('flooringType').value = '';
                document.getElementById('roomLength').value = '';
                document.getElementById('roomWidth').value = '';
                document.getElementById('roomNotes').value = '';
                
                // Reset moisture readings safely
                const moistureContainer = document.getElementById('moistureReadings');
                if (moistureContainer) {
                    moistureContainer.innerHTML = `
                        <div class="reading-input">
                            <select class="material-type">
                                <option value="">Material Type</option>
                                <option value="wood_floor">Wood Flooring</option>
                                <option value="subfloor">Subfloor</option>
                                <option value="carpet_pad">Carpet/Pad</option>
                                <option value="drywall_bottom">Drywall (Bottom)</option>
                                <option value="drywall_2ft">Drywall (2ft up)</option>
                                <option value="baseboard">Baseboard</option>
                                <option value="concrete">Concrete</option>
                                <option value="insulation">Insulation</option>
                            </select>
                            <input type="number" placeholder="% MC" class="moisture-reading">
                            <input type="text" placeholder="Location" class="reading-location">
                        </div>
                    `;
                }
                
                document.querySelectorAll('#step4 input[type="checkbox"]').forEach(cb => cb.checked = false);
                setupRoomAssessment();
            } else {
                nextStep();
            }
            saveProgress();
        }

        // Equipment recommendations based on IICRC standards
        function generateEquipmentRecommendations() {
            const equipmentPlan = document.getElementById('equipmentPlan');
            let totalEquipment = { dehumidifiers: 0, airMovers: 0 };
            
            equipmentPlan.innerHTML = '';

            Object.values(roomData).forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = 'equipment-room';
                
                const equipment = calculateEquipmentNeeds(room);
                totalEquipment.dehumidifiers += equipment.dehumidifiers;
                totalEquipment.airMovers += equipment.airMovers;

                const damageClass = determineDamageClass(room);
                
                roomDiv.innerHTML = `
                    <h5>${room.name} <span class="class-indicator ${damageClass.toLowerCase()}">${damageClass}</span></h5>
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">${room.area} sq ft | ${room.flooring}</p>
                    <div class="equipment-list">
                        <div class="equipment-item">
                            <span>🌀 Air Movers</span>
                            <strong>${equipment.airMovers}</strong>
                        </div>
                        <div class="equipment-item">
                            <span>💧 Dehumidifier Capacity</span>
                            <strong>${equipment.dehumidifierCapacity}</strong>
                        </div>
                        ${equipment.specialEquipment ? `<div class="equipment-item"><span>🔧 Special Equipment</span><strong>${equipment.specialEquipment}</strong></div>` : ''}
                    </div>
                    <p style="font-size: 0.85rem; margin-top: 8px; opacity: 0.9;">${equipment.rationale}</p>
                `;
                
                equipmentPlan.appendChild(roomDiv);
            });

            const totalDiv = document.createElement('div');
            totalDiv.className = 'equipment-room';
            totalDiv.style.background = 'rgba(255,255,255,0.2)';
            totalDiv.innerHTML = `
                <h5>🎯 Total Equipment Deployment</h5>
                <div class="equipment-list">
                    <div class="equipment-item">
                        <span>Total Air Movers Needed</span>
                        <strong>${totalEquipment.airMovers}</strong>
                    </div>
                    <div class="equipment-item">
                        <span>Total Dehumidifiers Needed</span>
                        <strong>${totalEquipment.dehumidifiers}</strong>
                    </div>
                </div>
            `;
            equipmentPlan.appendChild(totalDiv);
        }

        function calculateEquipmentNeeds(room) {
            let airMovers = 0;
            let dehumidifiers = 0;
            let dehumidifierCapacity = '';
            let specialEquipment = '';
            let rationale = '';

            const area = room.area;
            const hasWoodFlooring = room.flooring.includes('wood') || room.flooring.includes('hardwood') || room.flooring.includes('engineered');
            const hasCarpet = room.flooring.includes('carpet');
            const avgMoisture = room.moistureReadings.length > 0 ? 
                room.moistureReadings.reduce((sum, reading) => sum + reading.moisture, 0) / room.moistureReadings.length : 0;

            if (area <= 100) {
                airMovers = hasCarpet ? 2 : 1;
            } else if (area <= 300) {
                airMovers = hasCarpet ? 4 : 2;
            } else if (area <= 500) {
                airMovers = hasCarpet ? 6 : 3;
            } else {
                airMovers = Math.ceil(area / 100);
            }

            if (area <= 500) {
                dehumidifiers = 1;
                dehumidifierCapacity = 'Standard (70-80 pints/day)';
            } else if (area <= 1000) {
                dehumidifiers = 1;
                dehumidifierCapacity = 'Large (100+ pints/day)';
            } else {
                dehumidifiers = Math.ceil(area / 800);
                dehumidifierCapacity = `${dehumidifiers} x Large units`;
            }

            if (hasWoodFlooring && avgMoisture > 15) {
                specialEquipment = 'Floor mat system recommended';
            } else if (hasCarpet && avgMoisture > 20) {
                specialEquipment = 'Carpet extraction + air movement';
            }

            rationale = `Based on ${area} sq ft area, ${room.flooring} flooring, and average moisture content of ${avgMoisture.toFixed(1)}%`;

            return { airMovers, dehumidifiers, dehumidifierCapacity, specialEquipment, rationale };
        }

        function determineDamageClass(room) {
            const avgMoisture = room.moistureReadings.length > 0 ? 
                room.moistureReadings.reduce((sum, reading) => sum + reading.moisture, 0) / room.moistureReadings.length : 0;
            
            const hasStructuralMaterials = room.affectedMaterials.some(material => 
                material.includes('Drywall') || material.includes('Insulation') || material.includes('Subfloor')
            );

            if (avgMoisture < 15 && !hasStructuralMaterials) {
                return 'Class 1';
            } else if (avgMoisture < 25 && room.flooring.includes('carpet')) {
                return 'Class 2';
            } else if (hasStructuralMaterials || avgMoisture > 25) {
                return 'Class 3';
            } else {
                return 'Class 2';
            }
        }

        // Final summary generation
        function generateFinalSummary() {
            const insights = document.getElementById('keyInsights');
            const summary = document.getElementById('assessmentSummary');

            const totalArea = Object.values(roomData).reduce((sum, room) => sum + room.area, 0);
            const totalRooms = Object.keys(roomData).length;
            const primaryFlooring = getMostCommonFlooring();
            const highestMoisture = getHighestMoistureReading();
            const damageClasses = Object.values(roomData).map(room => determineDamageClass(room));
            const primaryClass = getMostCommonClass(damageClasses);

            insights.innerHTML = `
                <p><strong>📊 Scope:</strong> ${totalRooms} affected rooms, ${totalArea.toFixed(0)} total sq ft</p>
                <p><strong>🏠 Primary Flooring:</strong> ${primaryFlooring}</p>
                <p><strong>💧 Highest Moisture Reading:</strong> ${highestMoisture}%</p>
                <p><strong>⚡ Primary Damage Class:</strong> ${primaryClass}</p>
                <p><strong>🎯 Recommended Action:</strong> ${getRecommendedAction(primaryClass, highestMoisture)}</p>
            `;

            let summaryHTML = `
                <p><strong>Job Details:</strong></p>
                <p>• Address: ${document.getElementById('jobAddress').value}</p>
                <p>• Homeowner: ${document.getElementById('homeownerName').value}</p>
                <p>• Technician: ${document.getElementById('technicianName').value}</p>
                <p>• Water Source: ${document.getElementById('waterSource').options[document.getElementById('waterSource').selectedIndex].text}</p>
                <br>
                <p><strong>Environmental Conditions:</strong></p>
                <p>• Outside: ${environmentalData.temp}°F, ${environmentalData.humidity}% RH, ${environmentalData.gpp} gr/lb</p>
                <p>• Inside: ${document.getElementById('indoorTemp').value || 'N/A'}°F, ${document.getElementById('indoorHumidity').value || 'N/A'}% RH</p>
                <br>
                <p><strong>Room-by-Room Assessment:</strong></p>
            `;

            Object.values(roomData).forEach(room => {
                summaryHTML += `
                    <p><strong>${room.name}:</strong> ${room.area} sq ft, ${room.flooring}</p>
                    <p>  └ Damage Class: ${determineDamageClass(room)}</p>
                    <p>  └ Moisture Readings: ${room.moistureReadings.length} locations documented</p>
                `;
            });

            summary.innerHTML = summaryHTML;
        }

        function getMostCommonFlooring() {
            const flooringTypes = Object.values(roomData).map(room => room.flooring);
            return flooringTypes.sort((a,b) =>
                flooringTypes.filter(v => v===a).length - flooringTypes.filter(v => v===b).length
            ).pop() || 'Mixed';
        }

        function getHighestMoistureReading() {
            let highest = 0;
            Object.values(roomData).forEach(room => {
                room.moistureReadings.forEach(reading => {
                    if (reading.moisture > highest) highest = reading.moisture;
                });
            });
            return highest.toFixed(1);
        }

        function getMostCommonClass(classes) {
            return classes.sort((a,b) =>
                classes.filter(v => v===a).length - classes.filter(v => v===b).length
            ).pop() || 'Class 2';
        }

        function getRecommendedAction(primaryClass, highestMoisture) {
            if (primaryClass === 'Class 3' || highestMoisture > 25) {
                return 'Immediate professional drying and potential material removal required';
            } else if (primaryClass === 'Class 2') {
                return 'Professional drying equipment deployment recommended';
            } else {
                return 'Monitor and maintain proper drying conditions';
            }
        }

        // Email functionality
        async function sendReport() {
            document.getElementById('sendingReport').classList.add('active');
            
            const emailData = {
                to: ['jeannie@borestorationofbaldwincounty.com', 'zac@borestorationofbaldwincounty.com'],
                subject: `Water Damage Assessment - ${document.getElementById('jobAddress').value}`,
                body: generateEmailBody(),
                attachments: allPhotos
            };

            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                document.getElementById('sendingReport').classList.remove('active');
                document.getElementById('reportSent').style.display = 'block';
                
                clearProgress();
                
            } catch (error) {
                document.getElementById('sendingReport').classList.remove('active');
                alert('Error sending report. Please try again or contact support.');
            }
        }

        function generateEmailBody() {
            const totalArea = Object.values(roomData).reduce((sum, room) => sum + room.area, 0);
            const totalEquipment = calculateTotalEquipment();
            
            return `
WATER DAMAGE ASSESSMENT REPORT
═════════════════════════════════

JOB INFORMATION:
• Address: ${document.getElementById('jobAddress').value}
• Homeowner: ${document.getElementById('homeownerName').value}
• Contact: ${document.getElementById('contactPhone').value}
• Technician: ${document.getElementById('technicianName').value}
• Assessment Date: ${new Date().toLocaleDateString()}
• Water Source: ${document.getElementById('waterSource').options[document.getElementById('waterSource').selectedIndex].text}

ENVIRONMENTAL CONDITIONS:
• Outside: ${environmentalData.temp}°F, ${environmentalData.humidity}% RH, ${environmentalData.gpp} gr/lb GPP
• Inside: ${document.getElementById('indoorTemp').value || 'N/A'}°F, ${document.getElementById('indoorHumidity').value || 'N/A'}% RH

SCOPE SUMMARY:
• Total Affected Area: ${totalArea.toFixed(0)} sq ft
• Rooms Affected: ${Object.keys(roomData).length}
• Primary Damage Class: ${getMostCommonClass(Object.values(roomData).map(room => determineDamageClass(room)))}
• Highest Moisture Reading: ${getHighestMoistureReading()}%

EQUIPMENT DEPLOYMENT (IICRC Compliant):
• Air Movers Required: ${totalEquipment.airMovers}
• Dehumidifiers Required: ${totalEquipment.dehumidifiers}

ROOM-BY-ROOM DETAILS:
${Object.values(roomData).map(room => `
${room.name.toUpperCase()}:
  - Size: ${room.area} sq ft (${room.length}' x ${room.width}')
  - Flooring: ${room.flooring}
  - Damage Class: ${determineDamageClass(room)}
  - Moisture Readings: ${room.moistureReadings.map(r => `${r.material} @ ${r.location}: ${r.moisture}%`).join(', ')}
  - Affected Materials: ${room.affectedMaterials.join(', ')}
  - Photos: ${room.photos.length} attached
  ${room.notes ? `- Notes: ${room.notes}` : ''}
`).join('\n')}

RECOMMENDATIONS:
${getRecommendedAction(getMostCommonClass(Object.values(roomData).map(room => determineDamageClass(room))), parseFloat(getHighestMoistureReading()))}

ADDITIONAL COMMENTS:
${document.getElementById('finalComments').value || 'None'}

═════════════════════════════════
Report generated by IICRC-compliant assessment tool
Total Photos Attached: ${allPhotos.length}
            `;
        }

        function calculateTotalEquipment() {
            let totalAirMovers = 0;
            let totalDehumidifiers = 0;
            
            Object.values(roomData).forEach(room => {
                const equipment = calculateEquipmentNeeds(room);
                totalAirMovers += equipment.airMovers;
                totalDehumidifiers += equipment.dehumidifiers;
            });
            
            return { airMovers: totalAirMovers, dehumidifiers: totalDehumidifiers };
        }

        function generatePDF() {
            alert('PDF generation would be implemented with a library like jsPDF. For now, use the email report.');
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            setupAutoSave();
            loadProgress();
            updateProgress();
            getEnvironmentalData();
            initializeRoomSelection();
        });
    </script>
</body>
</html>
